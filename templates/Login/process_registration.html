{% extends "Base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="../../static/assets/css/style_cabinet.css">
<link rel="stylesheet" href="../../static/assets/css/style_registration.css">

<div class="container">
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="flash-messages">
    {% for category, message in messages %}
    <div class="flash-message flash-{{ category }}">
      <i class="fas {% if category == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}"></i>
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  <!-- Registration Header -->
  <div class="registration-header">
    <h1><i class="fas fa-user-plus"></i> Завершение регистрации</h1>
    <p>Пожалуйста, заполните информацию о себе для персонализации вашего опыта</p>
  </div>

  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="step active" id="step-1">
      <div class="step-number">1</div>
      <div class="step-label">Личные данные</div>
    </div>
    <div class="step" id="step-2">
      <div class="step-number">2</div>
      <div class="step-label">Параметры питания</div>
    </div>
  </div>

  <form id="registration-form" action="{{ url_for('submit_registration') }}" method="POST"
    enctype="multipart/form-data">
    <!-- Personal Data Section -->
    <div class="registration-section" id="personal-data-section">
      <div class="section-header">
        <h2 class="section-title"><i class="fas fa-id-card"></i> Личные данные</h2>
      </div>

      {{ ProcessRegistration_form.csrf_token }}

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="name">{{ ProcessRegistration_form.name.label.text }}</label>
            {{ ProcessRegistration_form.name(class="form-control", required=True) }}
            <i class="fas fa-user form-icon"></i>
          </div>
        </div>
        <div class="form-col">
          <div class="form-group">
            <label for="age">{{ ProcessRegistration_form.age.label.text }}</label>
            {{ ProcessRegistration_form.age(class="form-control", required=True) }}
            <i class="fas fa-birthday-cake form-icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="weight">{{ ProcessRegistration_form.weight.label.text }}</label>
            {{ ProcessRegistration_form.weight(class="form-control", required=True) }}
            <i class="fas fa-weight form-icon"></i>
          </div>
        </div>
        <div class="form-col">
          <div class="form-group">
            <label for="height">{{ ProcessRegistration_form.height.label.text }}</label>
            {{ ProcessRegistration_form.height(class="form-control", required=True) }}
            <i class="fas fa-ruler-vertical form-icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="gender">{{ ProcessRegistration_form.gender.label.text }}</label>
            {{ ProcessRegistration_form.gender(class="form-control", required=True) }}
            <i class="fas fa-venus-mars form-icon"></i>
          </div>
        </div>
        <div class="form-col">
          <div class="form-group">
            <label for="activity">{{ ProcessRegistration_form.activity.label.text }}</label>
            {{ ProcessRegistration_form.activity(class="form-control", required=True) }}
            <i class="fas fa-running form-icon"></i>
          </div>
        </div>
      </div>

      <div class="avatar-upload">
        <label for="avatar"><i class="fas fa-image"></i> {{ ProcessRegistration_form.avatar.label.text }}</label>
        {{ ProcessRegistration_form.avatar(class="form-control") }}
        <p style="margin-top: 10px; color: var(--text-light); font-size: 14px;">
          <i class="fas fa-info-circle"></i> Поддерживаемые форматы: JPG, PNG, JPEG
        </p>
      </div>

      <div class="navigation-buttons">
        <button type="button" class="btn btn-primary next-btn" id="to-nutrition-btn">
          <i class="fas fa-arrow-right"></i> Далее
        </button>
      </div>
    </div>

    <!-- Nutrition Data Section -->
    <div class="registration-section" id="nutrition-section" style="display: none;">
      <div class="section-header">
        <h2 class="section-title"><i class="fas fa-utensils"></i> Параметры питания</h2>
      </div>

      {{ nutrition_form.csrf_token }}

      <div class="recommended-section">
        <h3>Рекомендуемые показатели</h3>

        <div class="goal-buttons">
          <button type="button" class="btn btn-outline goal-btn" data-goal="lose">Сбросить вес</button>
          <button type="button" class="btn btn-outline goal-btn" data-goal="maintain">Поддержание веса</button>
          <button type="button" class="btn btn-outline goal-btn" data-goal="gain">Набор массы</button>
        </div>

        <div class="calculated-values">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="calc_calories">Расчетные калории</label>
                <input type="text" id="calc_calories" class="form-control" readonly>
                <i class="fas fa-fire form-icon"></i>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="calc_protein">Расчетные белки (г)</label>
                <input type="text" id="calc_protein" class="form-control" readonly>
                <i class="fas fa-drumstick-bite form-icon"></i>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="calc_fats">Расчетные жиры (г)</label>
                <input type="text" id="calc_fats" class="form-control" readonly>
                <i class="fas fa-cheese form-icon"></i>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="calc_carbs">Расчетные углеводы (г)</label>
                <input type="text" id="calc_carbs" class="form-control" readonly>
                <i class="fas fa-bread-slice form-icon"></i>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="calc_water">Расчетная вода (мл)</label>
                <input type="text" id="calc_water" class="form-control" readonly>
                <i class="fas fa-tint form-icon"></i>
              </div>
            </div>
          </div>

          <div class="insert-button">
            <button type="button" class="btn btn-primary" id="insert-values">
              <i class="fas fa-arrow-down"></i> Использовать значения
            </button>
          </div>
        </div>
      </div>

      <!-- Nutrition form fields -->
      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="calories">{{ nutrition_form.calories.label.text }}</label>
            {{ nutrition_form.calories(class="form-control", required=True) }}
            <i class="fas fa-fire form-icon"></i>
          </div>
        </div>
        <div class="form-col">
          <div class="form-group">
            <label for="protein">{{ nutrition_form.protein.label.text }}</label>
            {{ nutrition_form.protein(class="form-control", required=True) }}
            <i class="fas fa-drumstick-bite form-icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="fats">{{ nutrition_form.fats.label.text }}</label>
            {{ nutrition_form.fats(class="form-control", required=True) }}
            <i class="fas fa-cheese form-icon"></i>
          </div>
        </div>
        <div class="form-col">
          <div class="form-group">
            <label for="carbs">{{ nutrition_form.carbs.label.text }}</label>
            {{ nutrition_form.carbs(class="form-control", required=True) }}
            <i class="fas fa-bread-slice form-icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="water">{{ nutrition_form.water.label.text }}</label>
            {{ nutrition_form.water(class="form-control", required=True) }}
            <i class="fas fa-tint form-icon"></i>
          </div>
        </div>
      </div>

      <div class="navigation-buttons">
        <button type="button" class="btn btn-secondary back-btn" id="to-personal-btn">
          <i class="fas fa-arrow-left"></i> Назад
        </button>
        <button type="submit" class="btn btn-success">
          <i class="fas fa-check-circle"></i> {{ nutrition_form.submit.label.text }}
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Navigation between sections
    const personalSection = document.getElementById('personal-data-section');
    const nutritionSection = document.getElementById('nutrition-section');
    const toNutritionBtn = document.getElementById('to-nutrition-btn');
    const toPersonalBtn = document.getElementById('to-personal-btn');
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');

    toNutritionBtn.addEventListener('click', function () {
      // Validate personal data fields
      const nameInput = document.querySelector('[name="name"]');
      const ageInput = document.querySelector('[name="age"]');
      const weightInput = document.querySelector('[name="weight"]');
      const heightInput = document.querySelector('[name="height"]');
      const genderInput = document.querySelector('[name="gender"]');
      const activityInput = document.querySelector('[name="activity"]');

      if (!nameInput.value) {
        nameInput.classList.add('is-invalid');
        return;
      }

      if (!ageInput.value || ageInput.value < 1 || ageInput.value > 120) {
        ageInput.classList.add('is-invalid');
        return;
      }

      if (!weightInput.value || weightInput.value < 30 || weightInput.value > 300) {
        weightInput.classList.add('is-invalid');
        return;
      }

      if (!heightInput.value || heightInput.value < 100 || heightInput.value > 250) {
        heightInput.classList.add('is-invalid');
        return;
      }

      // If all validations pass, proceed to next section
      personalSection.style.display = 'none';
      nutritionSection.style.display = 'block';
      step1.classList.remove('active');
      step2.classList.add('active');

      // Calculate initial nutrition values based on user data
      calculateNutrition('maintain');
      document.querySelector('.goal-btn[data-goal="maintain"]').classList.add('active');
    });

    toPersonalBtn.addEventListener('click', function () {
      personalSection.style.display = 'block';
      nutritionSection.style.display = 'none';
      step2.classList.remove('active');
      step1.classList.add('active');
    });

    // Input validation - remove is-invalid class when user types
    const inputs = document.querySelectorAll('.form-control');
    inputs.forEach(input => {
      input.addEventListener('input', function () {
        this.classList.remove('is-invalid');
      });
    });

    // Goal button click handler
    const goalButtons = document.querySelectorAll('.goal-btn');
    const insertButton = document.getElementById('insert-values');
    let currentGoal = null;

    goalButtons.forEach(button => {
      button.addEventListener('click', function () {
        // Remove active class from all buttons
        goalButtons.forEach(btn => btn.classList.remove('active'));

        // Add active class to clicked button
        this.classList.add('active');

        // Store the selected goal
        currentGoal = this.getAttribute('data-goal');

        // Calculate nutrition values based on user data and selected goal
        calculateNutrition(currentGoal);
      });
    });

    // Insert button click handler
    if (insertButton) {
      insertButton.addEventListener('click', function () {
        if (!currentGoal) {
          alert('Пожалуйста, выберите цель перед вставкой значений');
          return;
        }

        // Get calculated values
        const calcCalories = document.getElementById('calc_calories').value;
        const calcProtein = document.getElementById('calc_protein').value;
        const calcFats = document.getElementById('calc_fats').value;
        const calcCarbs = document.getElementById('calc_carbs').value;
        const calcWater = document.getElementById('calc_water').value;

        // Insert values into the form fields
        const caloriesInput = document.querySelector('[name="calories"]');
        const proteinInput = document.querySelector('[name="protein"]');
        const fatsInput = document.querySelector('[name="fats"]');
        const carbsInput = document.querySelector('[name="carbs"]');
        const waterInput = document.querySelector('[name="water"]');

        caloriesInput.value = calcCalories;
        proteinInput.value = calcProtein;
        fatsInput.value = calcFats;
        carbsInput.value = calcCarbs;
        waterInput.value = calcWater;
      });
    }

    // Function to calculate nutrition values based on user data and goal
    function calculateNutrition(goal) {
      // Get user data
      const weight = parseFloat(document.querySelector('[name="weight"]').value) || 70;
      const height = parseFloat(document.querySelector('[name="height"]').value) || 170;
      const age = parseFloat(document.querySelector('[name="age"]').value) || 30;
      const gender = document.querySelector('[name="gender"]').value || 'male';
      const activity = document.querySelector('[name="activity"]').value || 'moderate';

      // Calculate BMR (Basal Metabolic Rate) using Harris-Benedict equation
      let bmr = 0;
      if (gender === 'male') {
        bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
      } else {
        bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
      }

      // Apply activity multiplier
      let activityMultiplier = 1.2; // Default: sedentary
      switch (activity) {
        case 'sedentary':
          activityMultiplier = 1.2;
          break;
        case 'light':
          activityMultiplier = 1.375;
          break;
        case 'moderate':
          activityMultiplier = 1.55;
          break;
        case 'active':
          activityMultiplier = 1.725;
          break;
        case 'very_active':
          activityMultiplier = 1.9;
          break;
      }

      let tdee = bmr * activityMultiplier; // Total Daily Energy Expenditure

      // Apply goal modifier
      let calories = tdee;
      switch (goal) {
        case 'lose':
          calories = tdee * 0.8; // 20% deficit for weight loss
          break;
        case 'maintain':
          calories = tdee; // Maintenance calories
          break;
        case 'gain':
          calories = tdee * 1.15; // 15% surplus for weight gain
          break;
      }

      // Calculate macronutrients
      let protein = 0, fats = 0, carbs = 0;

      switch (goal) {
        case 'lose':
          protein = weight * 2.2; // Higher protein for weight loss (2.2g per kg)
          fats = weight * 1; // 1g per kg of bodyweight
          carbs = (calories - (protein * 4) - (fats * 9)) / 4;
          break;
        case 'maintain':
          protein = weight * 1.8; // 1.8g per kg of bodyweight
          fats = weight * 1; // 1g per kg of bodyweight
          carbs = (calories - (protein * 4) - (fats * 9)) / 4;
          break;
        case 'gain':
          protein = weight * 2; // 2g per kg of bodyweight
          fats = weight * 1; // 1g per kg of bodyweight
          carbs = (calories - (protein * 4) - (fats * 9)) / 4;
          break;
      }

      // Calculate water intake (30ml per kg of bodyweight)
      let water = weight * 30;

      // Round values
      calories = Math.round(calories);
      protein = Math.round(protein);
      fats = Math.round(fats);
      carbs = Math.round(carbs);
      water = Math.round(water);

      // Update calculated fields
      document.getElementById('calc_calories').value = calories;
      document.getElementById('calc_protein').value = protein;
      document.getElementById('calc_fats').value = fats;
      document.getElementById('calc_carbs').value = carbs;
      document.getElementById('calc_water').value = water;
    }

    // File upload preview
    const fileInput = document.querySelector('[name="avatar"]');
    if (fileInput) {
      fileInput.addEventListener('change', function () {
        const fileHint = this.parentElement.querySelector('p');
        if (this.files.length > 0) {
          fileHint.textContent = `Выбран файл: ${this.files[0].name}`;
        } else {
          fileHint.textContent = 'Поддерживаемые форматы: JPG, PNG, JPEG';
        }
      });
    }
  });
</script>
{% endblock %}