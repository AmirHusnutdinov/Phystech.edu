{% extends "Base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="../../static/assets/css/style_cabinet.css">
<div class="container">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        <i class="fas {% if category == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Cabinet Header -->
    <div class="cabinet-header">
        <div class="avatar-container">
            {% if avatar %}
                <img src="{{ user.avatar }}" alt="Аватар пользователя">
            {% else %}
                <img src="/static/images/default-avatar.png" alt="Аватар по умолчанию">
            {% endif %}
        </div>
        <div class="user-info">
            <h1>{{ user.name }}</h1>
            <p><i class="fas fa-envelope"></i> {{ user.email }}</p>
            <p><i class="fas fa-user"></i> {{ user.login }}</p>
        </div>
    </div>

    <!-- Personal Data Section -->
    <div class="cabinet-section" id="profile-section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-id-card"></i> Личные данные</h2>
            <button class="btn btn-primary edit-btn" data-target="profile-form">
                <i class="fas fa-edit"></i> Изменить
            </button>
        </div>
        
        <form id="profile-form" action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data">
            {{ profile_form.csrf_token }}
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="name">{{ profile_form.name.label.text }}</label>
                        {{ profile_form.name(class="form-control", disabled=True, value=user.name) }}
                        <i class="fas fa-user form-icon"></i>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="login">{{ profile_form.login.label.text }}</label>
                        {{ profile_form.login(class="form-control", disabled=True, value=user.login) }}
                        <i class="fas fa-user-tag form-icon"></i>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="email">{{ profile_form.email.label.text }}</label>
                        {{ profile_form.email(class="form-control", disabled=True, value=user.email) }}
                        <i class="fas fa-envelope form-icon"></i>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="age">{{ profile_form.age.label.text }}</label>
                        {{ profile_form.age(class="form-control", disabled=True, value=user.age) }}
                        <i class="fas fa-birthday-cake form-icon"></i>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="weight">{{ profile_form.weight.label.text }}</label>
                        {{ profile_form.weight(class="form-control", disabled=True, value=user.weight) }}
                        <i class="fas fa-weight form-icon"></i>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="height">{{ profile_form.height.label.text }}</label>
                        {{ profile_form.height(class="form-control", disabled=True, value=user.height) }}
                        <i class="fas fa-ruler-vertical form-icon"></i>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="gender">{{ profile_form.gender.label.text }}</label>
                        {{ profile_form.gender(class="form-control", disabled=True) }}
                        <i class="fas fa-venus-mars form-icon"></i>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="activity">{{ profile_form.activity.label.text }}</label>
                        {{ profile_form.activity(class="form-control", disabled=True) }}
                        <i class="fas fa-running form-icon"></i>
                    </div>
                </div>
            </div>
            
            <div class="avatar-upload" style="display: none;">
                <label for="avatar"><i class="fas fa-image"></i> {{ profile_form.avatar.label.text }}</label>
                {{ profile_form.avatar(class="form-control") }}
                <p style="margin-top: 10px; color: var(--text-light); font-size: 14px;">
                    <i class="fas fa-info-circle"></i> Поддерживаемые форматы: JPG, PNG, JPEG
                </p>
            </div>
            
            <div class="action-buttons" id="profile-actions">
                <button type="button" class="btn btn-danger cancel-btn" data-target="profile-form">
                    <i class="fas fa-times"></i> Отмена
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </div>
        </form>
    </div>

    <!-- Nutrition Data Section -->
    <div class="cabinet-section" id="nutrition-section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-utensils"></i> Данные КБЖУ</h2>
            <button class="btn btn-primary edit-btn" data-target="nutrition-form">
                <i class="fas fa-edit"></i> Изменить
            </button>
        </div>
        
        <!-- Nutrition Stats Cards -->
        <div class="nutrition-stats">
            <div class="stat-card">
                <div class="stat-icon calories-icon">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-value">{{ user.calories }}</div>
                <div class="stat-label">Калории</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon protein-icon">
                    <i class="fas fa-drumstick-bite"></i>
                </div>
                <div class="stat-value">{{ user.proteins }}</div>
                <div class="stat-label">Белки (г)</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon fats-icon">
                    <i class="fas fa-cheese"></i>
                </div>
                <div class="stat-value">{{ user.fats }}</div>
                <div class="stat-label">Жиры (г)</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon carbs-icon">
                    <i class="fas fa-bread-slice"></i>
                </div>
                <div class="stat-value">{{ user.carbs }}</div>
                <div class="stat-label">Углеводы (г)</div>
            </div>
        </div>
        
        <form id="nutrition-form" action="{{ url_for('update_nutrition') }}" method="POST">
            {{ nutrition_form.csrf_token }}
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="calories">{{ nutrition_form.calories.label.text }}</label>
                        {{ nutrition_form.calories(class="form-control", disabled=True, value=user.calories) }}
                        <i class="fas fa-fire form-icon"></i>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="protein">{{ nutrition_form.protein.label.text }}</label>
                        {{ nutrition_form.protein(class="form-control", disabled=True, value=user.proteins) }}
                        <i class="fas fa-drumstick-bite form-icon"></i>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="fats">{{ nutrition_form.fats.label.text }}</label>
                        {{ nutrition_form.fats(class="form-control", disabled=True, value=user.fats) }}
                        <i class="fas fa-cheese form-icon"></i>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="carbs">{{ nutrition_form.carbs.label.text }}</label>
                        {{ nutrition_form.carbs(class="form-control", disabled=True, value=user.carbs) }}
                        <i class="fas fa-bread-slice form-icon"></i>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" id="nutrition-actions">
                <button type="button" class="btn btn-danger cancel-btn" data-target="nutrition-form">
                    <i class="fas fa-times"></i> Отмена
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Edit buttons
        const editButtons = document.querySelectorAll('.edit-btn');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const formId = this.getAttribute('data-target');
                enableFormEditing(formId);
            });
        });
        
        // Cancel buttons
        const cancelButtons = document.querySelectorAll('.cancel-btn');
        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const formId = this.getAttribute('data-target');
                disableFormEditing(formId);
            });
        });
        
        // Function to enable form editing
        function enableFormEditing(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('input, select');
            const actionButtons = form.querySelector('.action-buttons');
            
            // Enable all inputs except readonly ones
            inputs.forEach(input => {
                if (!input.hasAttribute('readonly')) {
                    input.disabled = false;
                }
            });
            
            // Show action buttons
            actionButtons.style.display = 'block';
            
            // Show avatar upload if it's the profile form
            if (formId === 'profile-form') {
                const avatarUpload = form.querySelector('.avatar-upload');
                if (avatarUpload) {
                    avatarUpload.style.display = 'block';
                }
            }
            
            // Hide edit button
            const sectionId = formId.replace('-form', '-section');
            const editBtn = document.querySelector(`#${sectionId} .edit-btn`);
            editBtn.style.display = 'none';
        }
        
        // Function to disable form editing
        function disableFormEditing(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('input, select');
            const actionButtons = form.querySelector('.action-buttons');
            
            // Disable all inputs
            inputs.forEach(input => {
                input.disabled = true;
            });
            
            // Hide action buttons
            actionButtons.style.display = 'none';
            
            // Hide avatar upload if it's the profile form
            if (formId === 'profile-form') {
                const avatarUpload = form.querySelector('.avatar-upload');
                if (avatarUpload) {
                    avatarUpload.style.display = 'none';
                }
            }
            
            // Show edit button
            const sectionId = formId.replace('-form', '-section');
            const editBtn = document.querySelector(`#${sectionId} .edit-btn`);
            editBtn.style.display = 'block';
            
            // Reset form to original values
            form.reset();
            
            // Restore original values after reset
            if (formId === 'profile-form') {
                document.querySelector('#profile-form [name="name"]').value = '{{ user.name }}';
                document.querySelector('#profile-form [name="login"]').value = '{{ user.login }}';
                document.querySelector('#profile-form [name="email"]').value = '{{ user.email }}';
                document.querySelector('#profile-form [name="age"]').value = '{{ user.age }}';
                document.querySelector('#profile-form [name="weight"]').value = '{{ user.weight }}';
                document.querySelector('#profile-form [name="height"]').value = '{{ user.height }}';
                
                // Для select элементов нужно установить выбранное значение
                const genderSelect = document.querySelector('#profile-form [name="gender"]');
                for (let i = 0; i < genderSelect.options.length; i++) {
                    if (genderSelect.options[i].value === '{{ user.gender }}') {
                        genderSelect.selectedIndex = i;
                        break;
                    }
                }
                
                const activitySelect = document.querySelector('#profile-form [name="activity"]');
                for (let i = 0; i < activitySelect.options.length; i++) {
                    if (activitySelect.options[i].value === '{{ user.activity }}') {
                        activitySelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            if (formId === 'nutrition-form') {
                document.querySelector('#nutrition-form [name="calories"]').value = '{{ user.calories }}';
                document.querySelector('#nutrition-form [name="protein"]').value = '{{ user.proteins }}';
                document.querySelector('#nutrition-form [name="fats"]').value = '{{ user.fats }}';
                document.querySelector('#nutrition-form [name="carbs"]').value = '{{ user.carbs }}';
            }
        }

        // Добавляем анимацию для flash-сообщений
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach((message, index) => {
            message.style.animationDelay = `${index * 0.1}s`;
            message.style.animation = 'fadeIn 0.5s ease-out forwards';
        });
    });
</script>
{% endblock %}
