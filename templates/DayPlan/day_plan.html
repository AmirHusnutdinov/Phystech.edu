{% extends "Base.html" %}

{% block content %}
<link rel="stylesheet" href="../../static/assets/css/style_day_plan.css">

<main class="container">
    <div class="plan-header">
        <h1>План питания на день</h1>
        <div class="date-display" id="current-date"></div>

        <div class="plan-controls">
            <div class="plan-type-toggle">
                <button class="plan-type-btn active" data-type="custom">Свободный режим</button>
                <button class="plan-type-btn" data-type="diet">Диета</button>
            </div>
            <a href="{{physical_exercises}}" class="exercise-link">Физические упражнения</a>
        </div>
    </div>

    <div class="nutrition-summary">
        <div class="nutrition-progress">
            <div class="progress-item">
                <div class="progress-label">
                    <span>Белки</span>
                    <span class="progress-value" id="protein-value">0/120 г</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="protein-fill" style="width: 0%"></div>
                </div>
            </div>

            <div class="progress-item">
                <div class="progress-label">
                    <span>Жиры</span>
                    <span class="progress-value" id="fat-value">0/50 г</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="fat-fill" style="width: 0%"></div>
                </div>
            </div>

            <div class="progress-item">
                <div class="progress-label">
                    <span>Углеводы</span>
                    <span class="progress-value" id="carb-value">0/250 г</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="carb-fill" style="width: 0%"></div>
                </div>
            </div>

            <div class="progress-item">
                <div class="progress-label">
                    <span>Калории</span>
                    <span class="progress-value" id="calorie-value">0/2000 ккал</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="calorie-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="water-tracker">
            <h3>Вода</h3>
            <div class="water-progress">
                <div class="water-glasses" id="water-glasses">
                    <!-- Glasses will be added dynamically -->
                </div>
                <div class="water-controls">
                    <button id="add-water">+ Добавить стакан (250 мл)</button>
                    <div class="water-value" id="water-value">0/2000 мл</div>
                </div>
            </div>
        </div>
    </div>

    <div class="meals-container" id="meals-container">
        {% if plan_type == 'diet' %}
        {% for meal in diet_meals %}
        <div class="meal-card" data-meal-id="{{ meal.id }}">
            <div class="meal-header">
                <div class="meal-type">{{ meal.type_name }}</div>
                <div class="meal-time">{{ meal.time }}</div>
            </div>
            <div class="meal-nutrition">
                <div class="meal-nutrition-item">
                    <span>Белки</span>
                    <span>{{ meal.protein }} г</span>
                </div>
                <div class="meal-nutrition-item">
                    <span>Жиры</span>
                    <span>{{ meal.fats }} г</span>
                </div>
                <div class="meal-nutrition-item">
                    <span>Углеводы</span>
                    <span>{{ meal.carbs }} г</span>
                </div>
                <div class="meal-nutrition-item">
                    <span>Калории</span>
                    <span>{{ meal.calories }} ккал</span>
                </div>
            </div>
            <div class="dishes-list">
                {% for dish in meal.dishes %}
                <div class="dish-item" data-meal-index="{{ loop.parent.index0 }}" data-dish-index="{{ loop.index0 }}">
                    <div class="dish-info">
                        <input type="checkbox" class="dish-checkbox" data-protein="{{ dish.protein }}"
                               data-fats="{{ dish.fats }}" data-carbs="{{ dish.carbs }}"
                               data-calories="{{ dish.calories }}">
                        <div>
                            <div class="dish-name">{{ dish.name }}</div>
                            <div class="dish-weight">{{ dish.weight }} г</div>
                        </div>
                    </div>
                    <div class="dish-nutrition">
                        <span>Б: {{ dish.protein }}г</span>
                        <span>Ж: {{ dish.fats }}г</span>
                        <span>У: {{ dish.carbs }}г</span>
                        <span>{{ dish.calories }} ккал</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <button class="add-meal-btn" id="add-meal-btn">+ Добавить прием пищи</button>

    <div class="save-plan-container">
        <button class="save-plan-btn" id="save-plan-btn">Сохранить план</button>
        <div id="save-status-message" class="status-message"></div>
    </div>

    <form id="save-meal-form" method="POST" action="/day_plan/save">
        <input type="hidden" id="meals-data" name="meals_data" value="">
        <input type="hidden" id="water-data" name="water_data" value="">
        <button type="submit" id="save-meal-form-btn" style="display: none;">Сохранить</button>
    </form>

    <!-- Meal Form Modal -->
    <div class="modal" id="meal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Добавить прием пищи</h2>
                <span class="close-modal" data-modal="meal-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="meal-form">
                    <div class="form-group">
                        <label for="meal-time">Время приема пищи:</label>
                        <input type="time" id="meal-time" value="12:00">
                    </div>

                    <div class="form-group meal-type-group" id="meal-type-group" style="display: none;">
                        <label for="meal-type">Тип приема пищи:</label>
                        <select id="meal-type">
                            <option value="breakfast">Завтрак</option>
                            <option value="lunch">Обед</option>
                            <option value="dinner">Ужин</option>
                            <option value="snack">Перекус</option>
                        </select>
                    </div>

                    <div class="meal-nutrition-summary">
                        <div class="meal-nutrition-item">
                            <span>Белки:</span>
                            <span id="meal-protein">0 г</span>
                        </div>
                        <div class="meal-nutrition-item">
                            <span>Жиры:</span>
                            <span id="meal-fat">0 г</span>
                        </div>
                        <div class="meal-nutrition-item">
                            <span>Углеводы:</span>
                            <span id="meal-carb">0 г</span>
                        </div>
                        <div class="meal-nutrition-item">
                            <span>Калории:</span>
                            <span id="meal-calories">0 ккал</span>
                        </div>
                    </div>

                    <div class="dishes-container" id="dishes-container">
                        <!-- Dishes will be added here -->
                    </div>

                    <button class="add-dish-btn" id="add-dish-btn">+ Добавить блюдо</button>

                    <div class="form-actions">
                        <button class="cancel-btn" id="cancel-meal-btn">Отмена</button>
                        <button class="save-btn" id="save-meal-btn">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dish Search Modal -->
    <div class="modal" id="dish-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Добавить блюдо</h2>
                <span class="close-modal" data-modal="dish-modal" id="close-dish-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="search-container">
                    <input type="text" id="dish-search" placeholder="Поиск блюда...">
                    <button id="search-btn">Поиск</button>
                </div>

                <div class="action-buttons">
                    <a href="/products/add" class="action-btn">Добавить продукт</a>
                    <a href="/recipes/add" class="action-btn">Добавить рецепт</a>
                </div>

                <div class="search-results" id="search-results">
                    <!-- Search results will be added here -->
                </div>

                <div class="dish-form" id="dish-form" style="display: none;">
                    <h3 id="selected-dish-name">Название блюда</h3>

                    <div class="form-group">
                        <label for="dish-weight">Вес (г):</label>
                        <input type="number" id="dish-weight" min="1" value="100">
                    </div>

                    <div class="dish-nutrition">
                        <div class="dish-nutrition-item">
                            <span>Белки:</span>
                            <span id="dish-protein">0 г</span>
                        </div>
                        <div class="dish-nutrition-item">
                            <span>Жиры:</span>
                            <span id="dish-fat">0 г</span>
                        </div>
                        <div class="dish-nutrition-item">
                            <span>Углеводы:</span>
                            <span id="dish-carb">0 г</span>
                        </div>
                        <div class="dish-nutrition-item">
                            <span>Калории:</span>
                            <span id="dish-calories">0 ккал</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="cancel-btn" id="cancel-dish-btn">Отмена</button>
                        <button class="save-btn" id="add-dish-to-meal-btn">Добавить в прием пищи</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if has_trainer %}
    <!-- Chat Button -->
    <button id="coach-chat-btn" class="coach-chat-btn">
        <i class="fas fa-comment-dots"></i>
        <span>Чат с тренером</span>
    </button>
    {% endif %}
</main>
{% if has_trainer %}
<!-- Chat Modal -->
<div id="coach-chat-modal" class="modal">
    <div class="modal-content chat-modal-content">
        <div class="modal-header chat-modal-header">
            <h2>Чат с тренером</h2>
            <span class="close-modal" data-modal="coach-chat-modal">&times;</span>
        </div>
        <div class="chat-container">
            <div class="chat-messages" id="coach-chat-messages">
                {% for message in messages %}
                <div class="message {{ message.type }}">
                    {% if message.type == 'received' %}
                    <div class="message-avatar">
                        <img src="{{ coach_avatar if coach_avatar else '../../static/assets/images/default_avatar.png' }}"
                             alt="">
                    </div>
                    {% endif %}
                    <div class="message-content">
                        {% if message.type == 'received' %}
                        <div class="message-sender">Тренер</div>
                        {% endif %}
                        <div class="message-text">{{ message.content }}</div>
                        <div class="message-time">{{ message.time }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="chat-input">
                <input type="text" id="coach-message-input" placeholder="Введите сообщение...">
                <button id="send-coach-message" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
<script>
    const cookies = {{ cookies | tojson }};
const cookies2 = {{ cookies2 | tojson }};
const DEMO_DISHES = {{ dishes | tojson }};

const DAILY_GOALS = {
  protein: parseFloat(cookies.proteins),
  fats: parseFloat(cookies.fats),
  carbs: parseFloat(cookies.carbs),
  calories: parseFloat(cookies.calories),
  water: parseFloat(cookies.water)
};

const GLASS_SIZE = 250;

let meals = [];
let waterAmount = 0;
let planType = 'custom';
let selectedDishId = null;
let currentMealIndex = null;

document.addEventListener('DOMContentLoaded', function () {
  updateCurrentDate();
  initWaterGlasses();

  const current = getCurrentNutrition();
  waterAmount = current.water;
  updateWaterDisplay();

  setupEventListeners();
  updateAddMealButtonVisibility();
  updateNutritionSummary();
});

function getCurrentNutrition() {
  return {
    protein: parseFloat(cookies2.protein || 0),
    fats: parseFloat(cookies2.fats || 0),
    carbs: parseFloat(cookies2.carbs || 0),
    calories: parseFloat(cookies2.calories || 0),
    water: parseFloat(cookies2.water || 0)
  };
}

function updateCurrentDate() {
  const dateElement = document.getElementById('current-date');
  const now = new Date();
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  dateElement.textContent = now.toLocaleDateString('ru-RU', options);
}

function initWaterGlasses() {
  const waterGlassesContainer = document.getElementById('water-glasses');
  waterGlassesContainer.innerHTML = '';
  const glassCount = Math.ceil(DAILY_GOALS.water / GLASS_SIZE);

  for (let i = 0; i < glassCount; i++) {
    const glass = document.createElement('div');
    glass.className = 'water-glass';
    glass.dataset.index = i;
    glass.addEventListener('click', function () {
      toggleWaterGlass(i);
    });
    waterGlassesContainer.appendChild(glass);
  }
}

function toggleWaterGlass(index) {
  const glasses = document.querySelectorAll('.water-glass');
  const clickedGlass = glasses[index];

  if (clickedGlass.classList.contains('filled')) {
    for (let i = index; i < glasses.length; i++) {
      glasses[i].classList.remove('filled');
    }
    waterAmount = GLASS_SIZE * index;
  } else {
    for (let i = 0; i <= index; i++) {
      glasses[i].classList.add('filled');
    }
    waterAmount = GLASS_SIZE * (index + 1);
  }

  updateWaterValue();
  prepareSaveData();
}

function addWaterGlass() {
  const glasses = document.querySelectorAll('.water-glass');
  const filledGlasses = document.querySelectorAll('.water-glass.filled');

  if (filledGlasses.length < glasses.length) {
    const nextIndex = filledGlasses.length;
    toggleWaterGlass(nextIndex);
  }
}

function updateWaterValue() {
  const waterValueElement = document.getElementById('water-value');
  waterValueElement.textContent = `${waterAmount}/${DAILY_GOALS.water} мл`;
}

function updateWaterDisplay() {
  updateWaterValue();
  const glasses = document.querySelectorAll('.water-glass');
  const filledGlasses = Math.floor(waterAmount / GLASS_SIZE);

  glasses.forEach((glass, index) => {
    if (index < filledGlasses) {
      glass.classList.add('filled');
    } else {
      glass.classList.remove('filled');
    }
  });
}

function updateAddMealButtonVisibility() {
  const addMealBtn = document.getElementById('add-meal-btn');
  if (addMealBtn) {
    addMealBtn.style.display = planType === 'diet' ? 'none' : 'block';
  }
}

function setupEventListeners() {
  const planTypeButtons = document.querySelectorAll('.plan-type-btn');
  planTypeButtons.forEach(button => {
    button.addEventListener('click', function () {
      planTypeButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      planType = this.dataset.type;

      const mealTypeGroup = document.getElementById('meal-type-group');
      mealTypeGroup.style.display = planType === 'diet' ? 'block' : 'none';

      updateAddMealButtonVisibility();
      renderMeals();
    });
  });

  document.getElementById('add-water').addEventListener('click', addWaterGlass);
  document.getElementById('add-meal-btn').addEventListener('click', openMealModal);

  document.querySelectorAll('.close-modal').forEach(closeBtn => {
    closeBtn.addEventListener('click', function () {
      const modalId = this.dataset.modal;
      document.getElementById(modalId).style.display = 'none';
    });
  });

  document.getElementById('cancel-meal-btn').addEventListener('click', function () {
    document.getElementById('meal-modal').style.display = 'none';
  });

  document.getElementById('save-meal-btn').addEventListener('click', saveMeal);
  document.getElementById('add-dish-btn').addEventListener('click', openDishModal);
  document.getElementById('close-dish-modal').addEventListener('click', function () {
    document.getElementById('dish-modal').style.display = 'none';
  });
  document.getElementById('cancel-dish-btn').addEventListener('click', function () {
    document.getElementById('dish-form').style.display = 'none';
    document.getElementById('search-results').style.display = 'block';
  });
  document.getElementById('search-btn').addEventListener('click', searchDishes);
  document.getElementById('dish-search').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      searchDishes();
    }
  });
  document.getElementById('dish-weight').addEventListener('input', updateDishNutrition);
  document.getElementById('add-dish-to-meal-btn').addEventListener('click', addDishToMeal);
  document.getElementById('save-meal-form').addEventListener('submit', function(e) {
    prepareSaveData();
  });
}

function openMealModal(event, mealIndex = null) {
  currentMealIndex = mealIndex;
  const modal = document.getElementById('meal-modal');
  const mealTimeInput = document.getElementById('meal-time');
  const mealTypeSelect = document.getElementById('meal-type');
  const dishesContainer = document.getElementById('dishes-container');

  dishesContainer.innerHTML = '';

  if (mealIndex === null) {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    mealTimeInput.value = `${hours}:${minutes}`;

    document.getElementById('meal-protein').textContent = '0 г';
    document.getElementById('meal-fat').textContent = '0 г';
    document.getElementById('meal-carb').textContent = '0 г';
    document.getElementById('meal-calories').textContent = '0 ккал';
  } else {
    const meal = meals[mealIndex];
    mealTimeInput.value = meal.time;

    if (planType === 'diet' && meal.type) {
      mealTypeSelect.value = meal.type;
    }

    meal.dishes.forEach((dish, index) => {
      addDishToContainer(dish, index);
    });

    updateMealNutrition();
  }

  modal.style.display = 'block';
}

function saveDayPlan() {
    const saveBtn = document.getElementById('save-plan-btn');
    const statusMessage = document.getElementById('save-status-message');

    saveBtn.disabled = true;
    saveBtn.textContent = 'Сохранение...';
    statusMessage.style.display = 'none';

    let actualProtein = parseFloat(cookies2.protein);
    let actualFats = parseFloat(cookies2.fats);
    let actualCarbs = parseFloat(cookies2.carbs);
    let actualCalories = parseFloat(cookies2.calories);
    let actualWater = parseFloat(cookies2.water);

    meals.forEach(meal => {
        meal.dishes.forEach(dish => {
            if (dish.consumed) {
                actualProtein += parseFloat(dish.protein);
                actualFats += parseFloat(dish.fats);
                actualCarbs += parseFloat(dish.carbs);
                actualCalories += dish.calories;
            }
        });
    });
    actualWater += waterAmount;
    const today = new Intl.DateTimeFormat('fr-CA', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).format(new Date()).replace(/\//g, '-');

    const data = {
        height: cookies.height,
        weight: cookies.weight,
        water: waterAmount,
        targetKBZHU: {
            protein: DAILY_GOALS.protein,
            fats: DAILY_GOALS.fats,
            carbs: DAILY_GOALS.carbs,
            calories: DAILY_GOALS.calories
        },
        actualKBZHU: {
            protein: actualProtein.toFixed(1),
            fats: actualFats.toFixed(1),
            carbs: actualCarbs.toFixed(1),
            calories: actualCalories
        },
        date: today
    };

    fetch('/day_plan/save_day_plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Ошибка сервера: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        statusMessage.textContent = data.message || 'План успешно сохранен!';
        statusMessage.className = 'status-message success';
        statusMessage.style.display = 'block';
    })
    .catch(error => {
        statusMessage.textContent = 'Ошибка при сохранении: ' + error.message;
        statusMessage.className = 'status-message error';
        statusMessage.style.display = 'block';
        console.error('Ошибка:', error);
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Сохранить план';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('save-plan-btn').addEventListener('click', saveDayPlan);
});

function saveMeal() {
  const mealTimeInput = document.getElementById('meal-time');
  const mealTypeSelect = document.getElementById('meal-type');
  const dishesContainer = document.getElementById('dishes-container');

  if (dishesContainer.children.length === 0) {
    alert('Добавьте хотя бы одно блюдо');
    return;
  }

  const meal = {
    time: mealTimeInput.value,
    dishes: [],
    protein: 0,
    fats: 0,
    carbs: 0,
    calories: 0
  };

  if (planType === 'diet') {
    meal.type = mealTypeSelect.value;
  }

  const dishItems = dishesContainer.querySelectorAll('.dish-item');
  dishItems.forEach(item => {
    const dishId = parseInt(item.dataset.id);
    const weight = parseInt(item.dataset.weight);
    const dish = DEMO_DISHES.find(d => d.id === dishId);

    if (dish) {
      const dishData = {
        id: dish.id,
        name: dish.name,
        weight: weight,
        protein: (dish.protein * weight / 100).toFixed(1),
        fats: (dish.fats * weight / 100).toFixed(1),
        carbs: (dish.carbs * weight / 100).toFixed(1),
        calories: Math.round(dish.calories * weight / 100),
        consumed: planType === 'custom' ? true : false
      };

      meal.dishes.push(dishData);
      meal.protein += parseFloat(dishData.protein);
      meal.fats += parseFloat(dishData.fats);
      meal.carbs += parseFloat(dishData.carbs);
      meal.calories += dishData.calories;
    }
  });

  meal.protein = meal.protein.toFixed(1);
  meal.fats = meal.fats.toFixed(1);
  meal.carbs = meal.carbs.toFixed(1);

  if (currentMealIndex !== null) {
    meals[currentMealIndex] = meal;
  } else {
    meals.push(meal);
  }

  document.getElementById('meal-modal').style.display = 'none';
  renderMeals();
  updateNutritionSummary();
}

function openDishModal() {
  document.getElementById('dish-modal').style.display = 'block';
  document.getElementById('dish-search').value = '';
  document.getElementById('dish-form').style.display = 'none';
  document.getElementById('search-results').style.display = 'block';
  document.getElementById('search-results').innerHTML = '';

  setTimeout(() => {
    document.getElementById('dish-search').focus();
  }, 100);
}

function searchDishes() {
  const searchInput = document.getElementById('dish-search');
  const searchResults = document.getElementById('search-results');
  const query = searchInput.value.trim().toLowerCase();

  searchResults.innerHTML = '';

  if (query.length < 2) {
    searchResults.innerHTML = '<p>Введите минимум 2 символа для поиска</p>';
    return;
  }

  const filteredDishes = DEMO_DISHES.filter(dish =>
    dish.name.toLowerCase().includes(query)
  );

  if (filteredDishes.length === 0) {
    searchResults.innerHTML = '<p>Ничего не найдено</p>';
    return;
  }

  filteredDishes.forEach(dish => {
    const dishElement = document.createElement('div');
    dishElement.className = 'search-result-item';
    dishElement.innerHTML = `
      <div class="dish-name">${dish.name}</div>
      <div class="dish-nutrition">
        <span>Б: ${dish.protein}г</span>
        <span>Ж: ${dish.fats}г</span>
        <span>У: ${dish.carbs}г</span>
        <span>${dish.calories} ккал</span>
      </div>
    `;

    dishElement.addEventListener('click', function () {
      selectDish(dish.id);
    });

    searchResults.appendChild(dishElement);
  });
}

function selectDish(dishId) {
  selectedDishId = dishId;
  const dish = DEMO_DISHES.find(d => d.id === dishId);

  if (dish) {
    document.getElementById('search-results').style.display = 'none';
    document.getElementById('dish-form').style.display = 'block';
    document.getElementById('selected-dish-name').textContent = dish.name;
    document.getElementById('dish-weight').value = 100;
    updateDishNutrition();
  }
}

function updateDishNutrition() {
  const weightInput = document.getElementById('dish-weight');
  const weight = parseInt(weightInput.value) || 0;

  if (weight <= 0) {
    weightInput.value = 1;
    return updateDishNutrition();
  }

  const dish = DEMO_DISHES.find(d => d.id === selectedDishId);

  if (dish) {
    document.getElementById('dish-protein').textContent = `${(dish.protein * weight / 100).toFixed(1)} г`;
    document.getElementById('dish-fat').textContent = `${(dish.fats * weight / 100).toFixed(1)} г`;
    document.getElementById('dish-carb').textContent = `${(dish.carbs * weight / 100).toFixed(1)} г`;
    document.getElementById('dish-calories').textContent = `${Math.round(dish.calories * weight / 100)} ккал`;
  }
}

function addDishToMeal() {
  const weight = parseInt(document.getElementById('dish-weight').value) || 0;

  if (weight <= 0) {
    alert('Вес должен быть больше 0');
    return;
  }

  const dish = DEMO_DISHES.find(d => d.id === selectedDishId);

  if (dish) {
    const dishData = {
      id: dish.id,
      name: dish.name,
      weight: weight,
      protein: (dish.protein * weight / 100).toFixed(1),
      fats: (dish.fats * weight / 100).toFixed(1),
      carbs: (dish.carbs * weight / 100).toFixed(1),
      calories: Math.round(dish.calories * weight / 100),
      consumed: false
    };

    const dishesContainer = document.getElementById('dishes-container');
    const dishIndex = dishesContainer.children.length;
    addDishToContainer(dishData, dishIndex);

    updateMealNutrition();
    document.getElementById('dish-modal').style.display = 'none';
  }
}

function addDishToContainer(dishData, index) {
  const dishesContainer = document.getElementById('dishes-container');

  const dishElement = document.createElement('div');
  dishElement.className = 'dish-item';
  dishElement.dataset.id = dishData.id;
  dishElement.dataset.weight = dishData.weight;
  dishElement.dataset.index = index;

  dishElement.innerHTML = `
    <div class="dish-info">
      <div class="dish-name">${dishData.name}</div>
      <div class="dish-weight">${dishData.weight} г</div>
    </div>
    <div class="dish-nutrition">
      <span>Б: ${dishData.protein}г</span>
      <span>Ж: ${dishData.fats}г</span>
      <span>У: ${dishData.carbs}г</span>
      <span>${dishData.calories} ккал</span>
    </div>
    <div class="dish-actions">
      <button class="remove-dish-btn" data-index="${index}">✕</button>
    </div>
  `;

  dishElement.querySelector('.remove-dish-btn').addEventListener('click', function (e) {
    e.stopPropagation();
    removeDishFromContainer(index);
  });

  dishesContainer.appendChild(dishElement);
}

function removeDishFromContainer(index) {
  const dishesContainer = document.getElementById('dishes-container');
  const dishElements = dishesContainer.querySelectorAll('.dish-item');

  if (index < dishElements.length) {
    dishElements[index].remove();

    dishesContainer.querySelectorAll('.dish-item').forEach((item, i) => {
      item.dataset.index = i;
      item.querySelector('.remove-dish-btn').dataset.index = i;
    });

    updateMealNutrition();
  }
}

function updateMealNutrition() {
  const dishesContainer = document.getElementById('dishes-container');
  const dishElements = dishesContainer.querySelectorAll('.dish-item');

  let protein = 0;
  let fats = 0;
  let carbs = 0;
  let calories = 0;

  dishElements.forEach(item => {
    const dishId = parseInt(item.dataset.id);
    const weight = parseInt(item.dataset.weight);
    const dish = DEMO_DISHES.find(d => d.id === dishId);

    if (dish) {
      protein += dish.protein * weight / 100;
      fats += dish.fats * weight / 100;
      carbs += dish.carbs * weight / 100;
      calories += Math.round(dish.calories * weight / 100);
    }
  });

  document.getElementById('meal-protein').textContent = `${protein.toFixed(1)} г`;
  document.getElementById('meal-fat').textContent = `${fats.toFixed(1)} г`;
  document.getElementById('meal-carb').textContent = `${carbs.toFixed(1)} г`;
  document.getElementById('meal-calories').textContent = `${calories} ккал`;
}

function renderMeals() {
  const mealsContainer = document.getElementById('meals-container');
  mealsContainer.innerHTML = '';

  const sortedMeals = [...meals].sort((a, b) => {
    return a.time.localeCompare(b.time);
  });

  sortedMeals.forEach((meal, index) => {
    const mealElement = document.createElement('div');
    mealElement.className = 'meal-card animate-in';

    let headerContent = '';
    if (planType === 'diet' && meal.type) {
      headerContent = `<div class="meal-type">${getMealTypeName(meal.type)}</div>`;
    } else {
      headerContent = `<div class="meal-time">${meal.time}</div>`;
    }

    let dishesListContent = '';
    if (planType === 'diet') {
      dishesListContent = meal.dishes.map((dish, dishIndex) => `
        <div class="dish-item ${dish.consumed ? 'consumed' : ''}" data-meal-index="${index}" data-dish-index="${dishIndex}">
          <div class="dish-info">
            <input type="checkbox" class="dish-checkbox" ${dish.consumed ? 'checked' : ''}>
            <div>
              <div class="dish-name">${dish.name}</div>
              <div class="dish-weight">${dish.weight} г</div>
            </div>
          </div>
          <div class="dish-nutrition">
            <span>Б: ${dish.protein}г</span>
            <span>Ж: ${dish.fats}г</span>
            <span>У: ${dish.carbs}г</span>
            <span>${dish.calories} ккал</span>
          </div>
        </div>
      `).join('');
    } else {
      dishesListContent = meal.dishes.map((dish, dishIndex) => `
        <div class="dish-item" data-meal-index="${index}" data-dish-index="${dishIndex}">
          <div class="dish-info">
            <div>
              <div class="dish-name">${dish.name}</div>
              <div class="dish-weight">${dish.weight} г</div>
            </div>
          </div>
          <div class="dish-nutrition">
            <span>Б: ${dish.protein}г</span>
            <span>Ж: ${dish.fats}г</span>
            <span>У: ${dish.carbs}г</span>
            <span>${dish.calories} ккал</span>
          </div>
        </div>
      `).join('');
    }

    mealElement.innerHTML = `
      <div class="meal-header">
        ${headerContent}
        <div class="meal-actions">
          <button class="edit-meal-btn" data-index="${index}">✎</button>
          <button class="delete-meal-btn" data-index="${index}">✕</button>
        </div>
      </div>
      <div class="meal-nutrition">
        <div class="meal-nutrition-item">
          <span>Белки</span>
          <span>${meal.protein} г</span>
        </div>
        <div class="meal-nutrition-item">
          <span>Жиры</span>
          <span>${meal.fats} г</span>
        </div>
        <div class="meal-nutrition-item">
          <span>Углеводы</span>
          <span>${meal.carbs} г</span>
        </div>
        <div class="meal-nutrition-item">
          <span>Калории</span>
          <span>${meal.calories} ккал</span>
        </div>
      </div>
      <div class="dishes-list">
        ${dishesListContent}
      </div>
    `;

    mealElement.querySelector('.edit-meal-btn').addEventListener('click', function () {
      openMealModal(null, index);
    });

    mealElement.querySelector('.delete-meal-btn').addEventListener('click', function () {
      if (confirm('Вы уверены, что хотите удалить этот прием пищи?')) {
        meals.splice(index, 1);
        renderMeals();
        updateNutritionSummary();
      }
    });

    if (planType === 'diet') {
      const checkboxes = mealElement.querySelectorAll('.dish-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
          const dishItem = this.closest('.dish-item');
          const mealIndex = parseInt(dishItem.dataset.mealIndex);
          const dishIndex = parseInt(dishItem.dataset.dishIndex);

          meals[mealIndex].dishes[dishIndex].consumed = this.checked;
          dishItem.classList.toggle('consumed', this.checked);

          updateNutritionSummary();
        });
      });
    }

    mealsContainer.appendChild(mealElement);
  });
}

function getMealTypeName(type) {
  const types = {
    'breakfast': 'Завтрак',
    'lunch': 'Обед',
    'dinner': 'Ужин',
    'snack': 'Перекус'
  };
  return types[type] || type;
}

function updateNutritionSummary() {
  const current = getCurrentNutrition();

  let consumedProtein = current.protein;
  let consumedFats = current.fats;
  let consumedCarbs = current.carbs;
  let consumedCalories = current.calories;
  waterAmount = current.water;

  meals.forEach(meal => {
    meal.dishes.forEach(dish => {
      if (dish.consumed) {
        consumedProtein += parseFloat(dish.protein);
        consumedFats += parseFloat(dish.fats);
        consumedCarbs += parseFloat(dish.carbs);
        consumedCalories += dish.calories;
      }
    });
  });

  consumedProtein = consumedProtein.toFixed(1);
  consumedFats = consumedFats.toFixed(1);
  consumedCarbs = consumedCarbs.toFixed(1);

  document.getElementById('protein-value').textContent = `${consumedProtein}/${DAILY_GOALS.protein} г`;
  document.getElementById('fat-value').textContent = `${consumedFats}/${DAILY_GOALS.fats} г`;
  document.getElementById('carb-value').textContent = `${consumedCarbs}/${DAILY_GOALS.carbs} г`;
  document.getElementById('calorie-value').textContent = `${consumedCalories}/${DAILY_GOALS.calories} ккал`;
  document.getElementById('water-value').textContent = `${waterAmount}/${DAILY_GOALS.water} мл`;

  document.getElementById('protein-fill').style.width = `${Math.min(100, (consumedProtein / DAILY_GOALS.protein) * 100)}%`;
  document.getElementById('fat-fill').style.width = `${Math.min(100, (consumedFats / DAILY_GOALS.fats) * 100)}%`;
  document.getElementById('carb-fill').style.width = `${Math.min(100, (consumedCarbs / DAILY_GOALS.carbs) * 100)}%`;
  document.getElementById('calorie-fill').style.width = `${Math.min(100, (consumedCalories / DAILY_GOALS.calories) * 100)}%`;


  updateWaterDisplay();
}

function prepareSaveData() {
  document.getElementById('meals-data').value = JSON.stringify(meals);
  document.getElementById('water-data').value = waterAmount.toString();
}

window.addEventListener('click', function (event) {
  const mealModal = document.getElementById('meal-modal');
  const dishModal = document.getElementById('dish-modal');
  const coachChatModal = document.getElementById('coach-chat-modal');

  if (event.target === mealModal) {
    mealModal.style.display = 'none';
  }

  if (event.target === dishModal) {
    dishModal.style.display = 'none';
  }

  if (event.target === coachChatModal) {
    coachChatModal.style.display = 'none';
  }
});

{% if has_trainer %}
document.addEventListener('DOMContentLoaded', function() {
  const coachChatBtn = document.getElementById('coach-chat-btn');
  const coachChatModal = document.getElementById('coach-chat-modal');
  const coachChatMessages = document.getElementById('coach-chat-messages');
  const coachMessageInput = document.getElementById('coach-message-input');
  const sendCoachMessageBtn = document.getElementById('send-coach-message');
  const closeModalBtns = document.querySelectorAll('.close-modal');

  let coachLastUpdate = new Date().toISOString();
  let coachMessageCheckInterval = null;

  function openModal(modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    if (modal === coachChatModal) {
      startCoachMessageChecking();
      setTimeout(() => {
        coachChatMessages.scrollTop = coachChatMessages.scrollHeight;
      }, 100);
    }
  }

  function closeModal(modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
    if (modal === coachChatModal) {
      stopCoachMessageChecking();
    }
  }

  function startCoachMessageChecking() {
    checkForNewCoachMessages();
    coachMessageCheckInterval = setInterval(checkForNewCoachMessages, 3000);
  }

  function stopCoachMessageChecking() {
    if (coachMessageCheckInterval) {
      clearInterval(coachMessageCheckInterval);
      coachMessageCheckInterval = null;
    }
  }

  if (coachChatBtn) {
    coachChatBtn.addEventListener('click', function() {
      openModal(coachChatModal);
    });
  }

  closeModalBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const modal = this.closest('.modal');
      closeModal(modal);
    });
  });

  window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
      closeModal(e.target);
    }
  });

  sendCoachMessageBtn.addEventListener('click', sendCoachMessage);
  coachMessageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendCoachMessage();
    }
  });

  async function sendCoachMessage() {
    const message = coachMessageInput.value.trim();
    if (message) {
      try {
        const response = await fetch('day_plan/send_message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: message
          })
        });

        const data = await response.json();

        if (data.status === 'success') {
          const messageHTML = `
            <div class="message sent">
              <div class="message-content">
                <div class="message-text">${message}</div>
                <div class="message-time">${data.time}</div>
              </div>
            </div>
          `;

          coachChatMessages.insertAdjacentHTML('beforeend', messageHTML);
          coachMessageInput.value = '';
          coachChatMessages.scrollTop = coachChatMessages.scrollHeight;
          coachLastUpdate = new Date().toISOString();
        } else {
          showNotification('Ошибка при отправке сообщения');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Ошибка соединения');
      }
    }
  }

  async function checkForNewCoachMessages() {
    try {
      const response = await fetch(`/day_plan/get_new_messages?last_update=${coachLastUpdate}`);
      const data = await response.json();
      if (data.status === 'success' && data.messages.length > 0) {
        coachLastUpdate = data.last_update;

        data.messages.forEach(msg => {
          const messageHTML = `
            <div class="message received">
              <div class="message-avatar">
                <img src="{{ coach_avatar if coach_avatar else '../../static/assets/images/default_avatar.png' }}"
                     alt="Аватар тренера">
              </div>
              <div class="message-content">
                <div class="message-sender">Тренер</div>
                <div class="message-text">${msg.content}</div>
                <div class="message-time">${msg.time}</div>
              </div>
            </div>
          `;

          coachChatMessages.insertAdjacentHTML('beforeend', messageHTML);
        });

        coachChatMessages.scrollTop = coachChatMessages.scrollHeight;
      }
    } catch (error) {
      console.error('Error checking for new coach messages:', error);
    }
  }

  function showNotification(message) {
    const notification = document.createElement('div');
    notification.classList.add('notification');
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  if (coachChatModal.style.display === 'block') {
    startCoachMessageChecking();
  }
});
{% endif %}

const style = document.createElement('style');
style.textContent = `
  :root {
    --primary-color: #1a73e8;
    --primary-light: #e8f0fe;
    --primary-dark: #0d47a1;
    --accent-color: #4285f4;
    --text-on-primary: #ffffff;
    --text-on-light: #1a73e8;
    --text-color: #202124;
    --button-hover: #0b5cdd;
  }

  body {
    color: var(--text-color);
  }

  .plan-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .exercise-link {
    display: inline-block;
    padding: 10px 15px;
    background-color: var(--primary-color);
    color: var(--text-on-primary);
    border-radius: 5px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .exercise-link:hover {
    background-color: var(--button-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .action-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .action-btn {
    flex: 1;
    padding: 10px;
    background-color: var(--primary-light);
    color: var(--text-on-light);
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-weight: 500;
    text-decoration: none;
    text-align: center;
  }

  .action-btn:hover {
    background-color: var(--primary-color);
    color: var(--text-on-primary);
  }

  .add-dish-btn, #add-water, .add-meal-btn, #search-btn, .save-btn {
    background-color: var(--primary-color);
    color: var(--text-on-primary);
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    margin: 10px 0;
    transition: all 0.3s ease;
  }

  .add-dish-btn:hover, #add-water:hover, .add-meal-btn:hover, #search-btn:hover, .save-btn:hover {
    background-color: var(--button-hover);
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .cancel-btn, .edit-meal-btn, .delete-meal-btn {
    background-color: #f1f3f4;
    color: var(--text-color);
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .cancel-btn:hover, .edit-meal-btn:hover {
    background-color: #e8eaed;
  }

  .delete-meal-btn:hover {
    background-color: #fce8e6;
    color: #d93025;
  }

  .progress-fill {
    background-color: var(--primary-color);
  }

  .plan-type-btn {
    background-color: var(--primary-light);
    color: var(--text-on-light);
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .plan-type-btn.active {
    background-color: var(--primary-color);
    color: var(--text-on-primary);
  }

  .water-glass {
    border: 2px solid var(--primary-color);
  }

  .water-glass.filled {
    background-color: var(--primary-color);
  }

  .search-result-item {
    border-left: 3px solid var(--primary-light);
    transition: all 0.3s ease;
  }

  .search-result-item:hover {
    border-left-color: var(--primary-color);
    background-color: var(--primary-light);
  }

  .dish-checkbox:checked {
    accent-color: var(--primary-color);
  }

  .modal-header {
    background-color: var(--primary-color);
    color: var(--text-on-primary);
  }

  .animate-in {
    animation: fadeIn 0.5s ease-out forwards;
    opacity: 0;
    transform: translateY(20px);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .meal-card {
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary-color);
  }

  .meal-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .dish-item {
    transition: all 0.3s ease;
    border-left: 2px solid transparent;
  }

  .dish-item:hover {
    background-color: var(--primary-light);
    border-left-color: var(--primary-color);
  }

  .modal {
    animation: fadeIn 0.3s ease-out;
  }

  .modal-content {
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  input[type="time"], input[type="number"], input[type="text"], select {
    border: 1px solid #dadce0;
    border-radius: 4px;
    padding: 8px;
    transition: border 0.3s ease;
  }

  input[type="time"]:focus, input[type="number"]:focus, input[type="text"]:focus, select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px var(--primary-light);
  }
`;
document.head.appendChild(style);

document.addEventListener('DOMContentLoaded', function() {
  const dietCheckboxes = document.querySelectorAll('.dish-checkbox');
  dietCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const dishItem = this.closest('.dish-item');
      dishItem.classList.toggle('consumed', this.checked);
      updateNutritionSummary();
    });
  });
});
</script>
{% endblock %}
