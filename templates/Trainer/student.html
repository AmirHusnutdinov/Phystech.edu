{% extends "Base.html" %}
{% block content %}
<link rel="stylesheet" href="../../static/assets/css/style_student.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet">
<body>
<div class="app-container">
    <br> <br><br>
    <!-- Main Content -->
    <main class="main-content">
        <!-- Week Visualization -->
        <section class="week-section card">
            <h2 class="section-title">Обзор недели</h2>

            <!-- Week Tabs -->
            <div class="week-tabs">
                <button class="week-tab active" data-week="current">Текущая неделя</button>
                <button class="week-tab" data-week="next">Следующая неделя</button>
                <button class="week-tab" data-week="third">Через неделю</button>
            </div>

            <!-- Week Containers -->
            <div class="week-container current active">
                <a href="/day/monday" class="day-card" data-day="monday">
                    <div class="day-icon">
                        <span>П</span>
                    </div>
                    <span class="day-name">Понедельник</span>
                    <div class="day-status complete">
                        <i class="fas fa-check"></i>
                    </div>
                </a>
                <a href="/day/tuesday" class="day-card active" data-day="tuesday">
                    <div class="day-icon">
                        <span>В</span>
                    </div>
                    <span class="day-name">Вторник</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/wednesday" class="day-card" data-day="wednesday">
                    <div class="day-icon">
                        <span>С</span>
                    </div>
                    <span class="day-name">Среда</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/thursday" class="day-card" data-day="thursday">
                    <div class="day-icon">
                        <span>Ч</span>
                    </div>
                    <span class="day-name">Четверг</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/friday" class="day-card" data-day="friday">
                    <div class="day-icon">
                        <span>П</span>
                    </div>
                    <span class="day-name">Пятница</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/saturday" class="day-card" data-day="saturday">
                    <div class="day-icon">
                        <span>С</span>
                    </div>
                    <span class="day-name">Суббота</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/sunday" class="day-card" data-day="sunday">
                    <div class="day-icon">
                        <span>В</span>
                    </div>
                    <span class="day-name">Воскресенье</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
            </div>

            <div class="week-container next">
                <a href="/day/next-monday" class="day-card" data-day="monday">
                    <div class="day-icon">
                        <span>П</span>
                    </div>
                    <span class="day-name">Понедельник</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/next-tuesday" class="day-card" data-day="tuesday">
                    <div class="day-icon">
                        <span>В</span>
                    </div>
                    <span class="day-name">Вторник</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/next-wednesday" class="day-card" data-day="wednesday">
                    <div class="day-icon">
                        <span>С</span>
                    </div>
                    <span class="day-name">Среда</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/next-thursday" class="day-card" data-day="thursday">
                    <div class="day-icon">
                        <span>Ч</span>
                    </div>
                    <span class="day-name">Четверг</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/next-friday" class="day-card" data-day="friday">
                    <div class="day-icon">
                        <span>П</span>
                    </div>
                    <span class="day-name">Пятница</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/next-saturday" class="day-card" data-day="saturday">
                    <div class="day-icon">
                        <span>С</span>
                    </div>
                    <span class="day-name">Суббота</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/next-sunday" class="day-card" data-day="sunday">
                    <div class="day-icon">
                        <span>В</span>
                    </div>
                    <span class="day-name">Воскресенье</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
            </div>

            <div class="week-container third">
                <a href="/day/third-monday" class="day-card" data-day="monday">
                    <div class="day-icon">
                        <span>П</span>
                    </div>
                    <span class="day-name">Понедельник</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/third-tuesday" class="day-card" data-day="tuesday">
                    <div class="day-icon">
                        <span>В</span>
                    </div>
                    <span class="day-name">Вторник</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/third-wednesday" class="day-card" data-day="wednesday">
                    <div class="day-icon">
                        <span>С</span>
                    </div>
                    <span class="day-name">Среда</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/third-thursday" class="day-card" data-day="thursday">
                    <div class="day-icon">
                        <span>Ч</span>
                    </div>
                    <span class="day-name">Четверг</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/third-friday" class="day-card" data-day="friday">
                    <div class="day-icon">
                        <span>П</span>
                    </div>
                    <span class="day-name">Пятница</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/third-saturday" class="day-card" data-day="saturday">
                    <div class="day-icon">
                        <span>С</span>
                    </div>
                    <span class="day-name">Суббота</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
                <a href="/day/third-sunday" class="day-card" data-day="sunday">
                    <div class="day-icon">
                        <span>В</span>
                    </div>
                    <span class="day-name">Воскресенье</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </a>
            </div>
        </section>

        <!-- Today's Nutrition -->
        <section class="nutrition-today card">
            <h2 class="section-title">Питание за сегодня</h2>
            <div class="nutrition-grid">
                <div class="nutrition-card">
                    <div class="nutrition-icon protein">
                        <i class="fas fa-drumstick-bite"></i>
                    </div>
                    <div class="nutrition-info">
                        <h3>Белки</h3>
                        <div class="progress-container">
                            <div class="progress-bar" style="--progress-width: 70%"></div>
                        </div>
                        <p><span class="current">{{nutrition_was}}</span>/<span class="target">{{nutrition_needed}}</span>г</p>
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-icon fat">
                        <i class="fas fa-cheese"></i>
                    </div>
                    <div class="nutrition-info">
                        <h3>Жиры</h3>
                        <div class="progress-container">
                            <div class="progress-bar" style="--progress-width: 60%"></div>
                        </div>
                        <p><span class="current">{{fats_was}}</span>/<span class="target">{{fats_needed}}</span>г</p>
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-icon carbs">
                        <i class="fas fa-bread-slice"></i>
                    </div>
                    <div class="nutrition-info">
                        <h3>Углеводы</h3>
                        <div class="progress-container">
                            <div class="progress-bar" style="--progress-width: 80%"></div>
                        </div>
                        <p><span class="current">{{carbohydrates_was}}</span>/<span class="target">{{carbohydrates_needed}}</span>г</p>
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-icon water">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="nutrition-info">
                        <h3>Вода</h3>
                        <div class="progress-container">
                            <div class="progress-bar" style="--progress-width: 50%"></div>
                        </div>
                        <p><span class="current">{{water_was}}</span>/<span class="target">{{water_needed}}</span>л</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact Button -->
        <button id="contact-btn" class="contact-btn">
            <i class="fas fa-comment-dots"></i>
            <span>Связаться со студентом</span>
        </button>

        <!-- Calendar Button -->
        <button id="calendar-btn" class="calendar-btn enhanced-calendar-btn">
            <i class="fas fa-calendar-alt"></i>
            <span>Перейти в календарь ученика</span>
        </button>
    </main>

    <!-- Chat Modal -->
    <div id="chat-modal" class="modal">
        <div class="modal-content chat-modal-content">
            <div class="modal-header">
                <h2>Чат с {{ cookies.name }}</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="chat-container">
                <div class="chat-messages">
                    {% for message in messages %}
                    <div class="message {{ message.type }}">
                        {% if message.type == 'received' %}
                        <div class="message-avatar">
                            <img src="{{ cookies.avatar if cookies.avatar else '../../static/assets/images/default_avatar.png' }}"
                                 alt="Аватар {{ cookies.name }}">
                        </div>
                        {% endif %}
                        <div class="message-content">
                            {% if message.type == 'received' %}
                            <div class="message-sender">{{ message.sender_name }}</div>
                            {% endif %}
                            <div class="message-text">{{ message.content }}</div>
                            <div class="message-time">{{ message.time }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Введите сообщение...">
                    <button id="send-message" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Details Modal -->
    <div id="day-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="day-title">Вторник, 14 мая</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="day-nutrition-summary">
                    <div class="summary-item">
                        <div class="summary-icon calories">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="summary-details">
                            <h3>Калории</h3>
                            <p>1,850 ккал</p>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon protein">
                            <i class="fas fa-drumstick-bite"></i>
                        </div>
                        <div class="summary-details">
                            <h3>Белки</h3>
                            <p>75г</p>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon fat">
                            <i class="fas fa-cheese"></i>
                        </div>
                        <div class="summary-details">
                            <h3>Жиры</h3>
                            <p>45г</p>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon carbs">
                            <i class="fas fa-bread-slice"></i>
                        </div>
                        <div class="summary-details">
                            <h3>Углеводы</h3>
                            <p>120г</p>
                        </div>
                    </div>
                </div>
                <div class="day-meals">
                    <h3>Приемы пищи</h3>
                    <div class="meal-section">
                        <h4>Завтрак</h4>
                        <div class="meal-items">
                            <div class="meal-item">
                                <div class="meal-item-name">Овсянка с ягодами</div>
                                <div class="meal-item-amount">1 порция</div>
                                <div class="meal-item-calories">320 ккал</div>
                            </div>
                            <div class="meal-item">
                                <div class="meal-item-name">Греческий йогурт</div>
                                <div class="meal-item-amount">150г</div>
                                <div class="meal-item-calories">150 ккал</div>
                            </div>
                        </div>
                    </div>
                    <div class="meal-section">
                        <h4>Обед</h4>
                        <div class="meal-items">
                            <div class="meal-item">
                                <div class="meal-item-name">Куриный салат</div>
                                <div class="meal-item-amount">1 порция</div>
                                <div class="meal-item-calories">450 ккал</div>
                            </div>
                            <div class="meal-item">
                                <div class="meal-item-name">Цельнозерновой хлеб</div>
                                <div class="meal-item-amount">1 ломтик</div>
                                <div class="meal-item-calories">80 ккал</div>
                            </div>
                        </div>
                    </div>
                    <div class="meal-section">
                        <h4>Ужин</h4>
                        <div class="meal-items">
                            <div class="meal-item">
                                <div class="meal-item-name">Жареный лосось</div>
                                <div class="meal-item-amount">150г</div>
                                <div class="meal-item-calories">280 ккал</div>
                            </div>
                            <div class="meal-item">
                                <div class="meal-item-name">Тушеные овощи</div>
                                <div class="meal-item-amount">200г</div>
                                <div class="meal-item-calories">120 ккал</div>
                            </div>
                            <div class="meal-item">
                                <div class="meal-item-name">Коричневый рис</div>
                                <div class="meal-item-amount">100г</div>
                                <div class="meal-item-calories">150 ккал</div>
                            </div>
                        </div>
                    </div>
                    <div class="meal-section">
                        <h4>Перекусы</h4>
                        <div class="meal-items">
                            <div class="meal-item">
                                <div class="meal-item-name">Яблоко</div>
                                <div class="meal-item-amount">1 среднее</div>
                                <div class="meal-item-calories">95 ккал</div>
                            </div>
                            <div class="meal-item">
                                <div class="meal-item-name">Миндаль</div>
                                <div class="meal-item-amount">30г</div>
                                <div class="meal-item-calories">180 ккал</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get all elements
            const weekTabs = document.querySelectorAll('.week-tab');
            const weekContainers = document.querySelectorAll('.week-container');
            const contactBtn = document.getElementById('contact-btn');
            const chatModal = document.getElementById('chat-modal');
            const closeModalBtns = document.querySelectorAll('.close-modal');
            const dayCards = document.querySelectorAll('.day-card');
            const dayDetailsModal = document.getElementById('day-details-modal');
            const dayTitle = document.getElementById('day-title');
            const calendarBtn = document.getElementById('calendar-btn');
            const chatMessages = document.querySelector('.chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendMessageBtn = document.getElementById('send-message');

            // Get student ID and initialize lastUpdate
            const studentId = "{{ student_id }}";
            let lastUpdate = new Date().toISOString();
            let messageCheckInterval = null;

            // Week tabs functionality
            weekTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    weekTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const weekType = this.getAttribute('data-week');
                    weekContainers.forEach(container => {
                        container.classList.remove('active');
                    });
                    document.querySelector(`.week-container.${weekType}`).classList.add('active');
                });
            });

            // Highlight current day
            function highlightCurrentDay() {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const dayMap = {
                    0: 'sunday',
                    1: 'monday',
                    2: 'tuesday',
                    3: 'wednesday',
                    4: 'thursday',
                    5: 'friday',
                    6: 'saturday'
                };
                const todayName = dayMap[dayOfWeek];
                document.querySelectorAll('.day-card').forEach(card => {
                    card.classList.remove('active');
                });
                const todayCard = document.querySelector(`.week-container.current .day-card[data-day="${todayName}"]`);
                if (todayCard) {
                    todayCard.classList.add('active');
                }
            }
            highlightCurrentDay();

            // Modal functions
            function openModal(modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                if (modal === chatModal) {
                    startMessageChecking();
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                }
            }

            function closeModal(modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
                if (modal === chatModal) {
                    stopMessageChecking();
                }
            }

            function startMessageChecking() {
                checkForNewMessages();
                messageCheckInterval = setInterval(checkForNewMessages, 3000);
            }

            function stopMessageChecking() {
                if (messageCheckInterval) {
                    clearInterval(messageCheckInterval);
                    messageCheckInterval = null;
                }
            }

            // Event listeners
            if (contactBtn) {
                contactBtn.addEventListener('click', () => openModal(chatModal));
            }

            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal');
                    closeModal(modal);
                });
            });

            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });

            dayCards.forEach(card => {
                card.addEventListener('click', () => {
                    const day = card.getAttribute('data-day');
                    dayTitle.textContent = day.charAt(0).toUpperCase() + day.slice(1) + ', 14 мая';
                    openModal(dayDetailsModal);
                });
            });

            // Chat functionality
            sendMessageBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            async function sendMessage() {
                const message = messageInput.value.trim();
                if (message) {
                    try {
                        const response = await fetch('/send_message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                student_id: studentId,
                                message: message
                            })
                        });

                        const data = await response.json();

                        if (data.status === 'success') {
                            const messageHTML = `
                                <div class="message sent">
                                    <div class="message-content">
                                        <div class="message-text">${message}</div>
                                        <div class="message-time">${data.time}</div>
                                    </div>
                                </div>
                            `;

                            chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                            messageInput.value = '';
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            lastUpdate = new Date().toISOString();
                        } else {
                            showNotification('Ошибка при отправке сообщения');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('Ошибка соединения');
                    }
                }
            }

            async function checkForNewMessages() {
                try {
                    const response = await fetch(`/get_new_messages/${studentId}?last_update=${lastUpdate}`);
                    const data = await response.json();

                    if (data.status === 'success' && data.messages.length > 0) {
                        lastUpdate = data.last_update;

                        data.messages.forEach(msg => {
                            const messageHTML = `
                                <div class="message received">
                                    <div class="message-avatar">
                                        <img src="{{ cookies.avatar if cookies.avatar else '../../static/assets/images/default_avatar.png' }}"
                                             alt="Аватар {{ cookies.name }}">
                                    </div>
                                    <div class="message-content">
                                        <div class="message-sender">{{ cookies.name }}</div>
                                        <div class="message-text">${msg.content}</div>
                                        <div class="message-time">${msg.time}</div>
                                    </div>
                                </div>
                            `;

                            chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                        });

                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error checking for new messages:', error);
                }
            }

            function showNotification(message) {
                const notification = document.createElement('div');
                notification.classList.add('notification');
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            // Calendar button functionality
            if (calendarBtn) {
                calendarBtn.addEventListener('click', () => {
                    window.location.href = `/calendar/${studentId}`;
                });
            }

            // Add animation classes to cards
            document.querySelectorAll('.card').forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('animate-in');
                }, index * 100);
            });

            // Start message checking if chat is open
            if (chatModal.classList.contains('active')) {
                startMessageChecking();
            }
        });
    </script>
</div>
</body>
{% endblock %}