<!-- Trainer/student.html -->
{% extends "Base.html" %}
{% block content %}
<link rel="stylesheet" href="../../static/assets/css/style_student.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<div class="app-container">
    <br> <br><br>
    <!-- Main Content -->
    <main class="main-content">
        <!-- Week Visualization -->
        <section class="week-section card">
            <h2 class="section-title">Обзор недели</h2>
            <div class="week-container">
                <!--  Пример, можно сделать динамически на основе данных -->
                <div class="day-card" data-day="monday">
                    <div class="day-icon">
                        <span>П</span>
                    </div>
                    <span class="day-name">Понедельник</span>
                    <div class="day-status complete">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
                <div class="day-card active" data-day="tuesday">
                    <div class="day-icon">
                        <span>В</span>
                    </div>
                    <span class="day-name">Вторник</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </div>
                <div class="day-card" data-day="wednesday">
                    <div class="day-icon">
                        <span>С</span>
                    </div>
                    <span class="day-name">Среда</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </div>
                <div class="day-card" data-day="thursday">
                    <div class="day-icon">
                        <span>Ч</span>
                    </div>
                    <span class="day-name">Четверг</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </div>
                <div class="day-card" data-day="friday">
                    <div class="day-icon">
                        <span>П</span>
                    </div>
                    <span class="day-name">Пятница</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </div>
                <div class="day-card" data-day="saturday">
                    <div class="day-icon">
                        <span>С</span>
                    </div>
                    <span class="day-name">Суббота</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </div>
                <div class="day-card" data-day="sunday">
                    <div class="day-icon">
                        <span>В</span>
                    </div>
                    <span class="day-name">Воскресенье</span>
                    <div class="day-status">
                        <i class="fas fa-utensils"></i>
                    </div>
                </div>
            </div>
            <button id="add-food-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Добавить еду
            </button>
        </section>

        <!-- Today's Nutrition -->
        <section class="nutrition-today card">
            <h2 class="section-title">Питание за сегодня</h2>
            <div class="nutrition-grid">
                <div class="nutrition-card">
                    <div class="nutrition-icon protein">
                        <i class="fas fa-drumstick-bite"></i>
                    </div>
                    <div class="nutrition-info">
                        <h3>Белки</h3>
                        <div class="progress-container">
                            <!--  динамический расчет  -->
                            <div class="progress-bar"
                                 style="--progress-width: {{ (cookies.proteins / (cookies.proteins * 1.2)) * 100 if cookies.proteins else 0 }}%"></div>
                        </div>
                        <p><span class="current">{{ cookies.proteins }}</span>/<span class="target">{{ (cookies.proteins * 1.2) | round(0, 'ceil') if cookies.proteins }}</span>г
                        </p>
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-icon fat">
                        <i class="fas fa-cheese"></i>
                    </div>
                    <div class="nutrition-info">
                        <h3>Жиры</h3>
                        <div class="progress-container">
                            <div class="progress-bar"
                                 style="--progress-width: {{ (cookies.fats / (cookies.fats * 1.2)) * 100 if cookies.fats else 0 }}%"></div>
                        </div>
                        <p><span class="current">{{ cookies.fats }}</span>/<span class="target">{{ (cookies.fats * 1.2) | round(0, 'ceil') if cookies.fats }}</span>г
                        </p>
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-icon carbs">
                        <i class="fas fa-bread-slice"></i>
                    </div>
                    <div class="nutrition-info">
                        <h3>Углеводы</h3>
                        <div class="progress-container">
                            <div class="progress-bar"
                                 style="--progress-width: {{ (cookies.carbs / (cookies.carbs * 1.2)) * 100 if cookies.carbs else 0 }}%"></div>
                        </div>
                        <p><span class="current">{{ cookies.carbs }}</span>/<span class="target">{{ (cookies.carbs * 1.2) | round(0, 'ceil') if cookies.carbs}}</span>г
                        </p>
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-icon water">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="nutrition-info">
                        <h3>Вода</h3>
                        <div class="progress-container">
                            <div class="progress-bar"
                                 style="--progress-width: {{ (cookies.water / (cookies.water * 1.2)) * 100 if cookies.water else 0 }}%"></div>
                        </div>
                        <p><span class="current">{{ cookies.water }}</span>/<span class="target">{{ (cookies.water * 1.2) | round(1) if cookies.water }}</span>л
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact Button -->
        <button id="contact-btn" class="contact-btn">
            <i class="fas fa-comment-dots"></i>
            <span>Связаться со студентом</span>
        </button>

        <!-- Calendar Button -->
        <button id="calendar-btn" class="calendar-btn enhanced-calendar-btn">
            <i class="fas fa-calendar-alt"></i>
            <span>Перейти в календарь ученика</span>
        </button>
    </main>

    <!-- Food Input Modal -->
    <div id="food-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Добавить еду</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="food-form">
                    <div class="form-group">
                        <label for="food-name">Название еды</label>
                        <input type="text" id="food-name" placeholder="Например, Куриная грудка" required>
                    </div>
                    <div class="form-group">
                        <label for="food-category">Категория</label>
                        <select id="food-category">
                            <option value="protein">Белки</option>
                            <option value="carbs">Углеводы</option>
                            <option value="fat">Жиры</option>
                            <option value="fruit">Фрукты</option>
                            <option value="vegetable">Овощи</option>
                            <option value="dairy">Молочные продукты</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="food-amount">Количество</label>
                            <input type="number" id="food-amount" min="0" step="1" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="food-unit">Единица измерения</label>
                            <select id="food-unit">
                                <option value="g">граммы</option>
                                <option value="ml">миллилитры</option>
                                <option value="oz">унции</option>
                                <option value="serving">порция</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="food-protein">Белки (г)</label>
                            <input type="number" id="food-protein" min="0" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label for="food-fat">Жиры (г)</label>
                            <input type="number" id="food-fat" min="0" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                            <label for="food-carbs">Углеводы (г)</label>
                            <input type="number" id="food-carbs" min="0" step="0.1" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="food-calories">Калории</label>
                        <input type="number" id="food-calories" min="0" step="1" value="0">
                    </div>
                    <div class="form-group">
                        <label for="meal-time">Время приема пищи</label>
                        <select id="meal-time">
                            <option value="breakfast">Завтрак</option>
                            <option value="lunch">Обед</option>
                            <option value="dinner">Ужин</option>
                            <option value="snack">Перекус</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Добавить еду</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="modal">
        <div class="modal-content chat-modal-content">
            <div class="modal-header">
                <h2>Чат с {{ cookies.name }}</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="chat-container">
                <div class="chat-messages">
                    {% for message in messages %}
                    <div class="message {{ message.type }}">
                        {% if message.type == 'received' %}
                        <div class="message-avatar">
                            <img src="{{ cookies.avatar if cookies.avatar else '../../static/assets/images/default_avatar.png' }}" 
                                 alt="Аватар {{ cookies.name }}">
                        </div>
                        {% endif %}
                        <div class="message-content">
                            {% if message.type == 'received' %}
                            <div class="message-sender">{{ message.sender_name }}</div>
                            {% endif %}
                            <div class="message-text">{{ message.content }}</div>
                            <div class="message-time">{{ message.time }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="message-input" placeholder="Введите сообщение...">
                <button id="send-message" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

<!-- Day Details Modal -->
<div id="day-details-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="day-title">Вторник, 14 мая</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="day-nutrition-summary">
                <div class="summary-item">
                    <div class="summary-icon calories">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="summary-details">
                        <h3>Калории</h3>
                        <p>1,850 ккал</p>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-icon protein">
                        <i class="fas fa-drumstick-bite"></i>
                    </div>
                    <div class="summary-details">
                        <h3>Белки</h3>
                        <p>75г</p>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-icon fat">
                        <i class="fas fa-cheese"></i>
                    </div>
                    <div class="summary-details">
                        <h3>Жиры</h3>
                        <p>45г</p>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-icon carbs">
                        <i class="fas fa-bread-slice"></i>
                    </div>
                    <div class="summary-details">
                        <h3>Углеводы</h3>
                        <p>120г</p>
                    </div>
                </div>
            </div>
            <div class="day-meals">
                <h3>Приемы пищи</h3>
                <!-- Здесь  нужно  больше  данных, чтобы  сделать  динамически -->
                <div class="meal-section">
                    <h4>Завтрак</h4>
                    <div class="meal-items">
                        <div class="meal-item">
                            <div class="meal-item-name">Овсянка с ягодами</div>
                            <div class="meal-item-amount">1 порция</div>
                            <div class="meal-item-calories">320 ккал</div>
                        </div>
                        <div class="meal-item">
                            <div class="meal-item-name">Греческий йогурт</div>
                            <div class="meal-item-amount">150г</div>
                            <div class="meal-item-calories">150 ккал</div>
                        </div>
                    </div>
                </div>
                <div class="meal-section">
                    <h4>Обед</h4>
                    <div class="meal-items">
                        <div class="meal-item">
                            <div class="meal-item-name">Куриный салат</div>
                            <div class="meal-item-amount">1 порция</div>
                            <div class="meal-item-calories">450 ккал</div>
                        </div>
                        <div class="meal-item">
                            <div class="meal-item-name">Цельнозерновой хлеб</div>
                            <div class="meal-item-amount">1 ломтик</div>
                            <div class="meal-item-calories">80 ккал</div>
                        </div>
                    </div>
                </div>
                <div class="meal-section">
                    <h4>Ужин</h4>
                    <div class="meal-items">
                        <div class="meal-item">
                            <div class="meal-item-name">Жареный лосось</div>
                            <div class="meal-item-amount">150г</div>
                            <div class="meal-item-calories">280 ккал</div>
                        </div>
                        <div class="meal-item">
                            <div class="meal-item-name">Тушеные овощи</div>
                            <div class="meal-item-amount">200г</div>
                            <div class="meal-item-calories">120 ккал</div>
                        </div>
                        <div class="meal-item">
                            <div class="meal-item-name">Коричневый рис</div>
                            <div class="meal-item-amount">100г</div>
                            <div class="meal-item-calories">150 ккал</div>
                        </div>
                    </div>
                </div>
                <div class="meal-section">
                    <h4>Перекусы</h4>
                    <div class="meal-items">
                        <div class="meal-item">
                            <div class="meal-item-name">Яблоко</div>
                            <div class="meal-item-amount">1 среднее</div>
                            <div class="meal-item-calories">95 ккал</div>
                        </div>
                        <div class="meal-item">
                            <div class="meal-item-name">Миндаль</div>
                            <div class="meal-item-amount">30г</div>
                            <div class="meal-item-calories">180 ккал</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // DOM Elements
    const addFoodBtn = document.getElementById('add-food-btn');
    const foodModal = document.getElementById('food-modal');
    const chatModal = document.getElementById('chat-modal');
    const dayDetailsModal = document.getElementById('day-details-modal');
    const contactBtn = document.getElementById('contact-btn');
    const closeModalBtns = document.querySelectorAll('.close-modal');
    const foodForm = document.getElementById('food-form');
    const sendMessageBtn = document.getElementById('send-message');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.querySelector('.chat-messages');
    const dayCards = document.querySelectorAll('.day-card');
    const calendarBtn = document.getElementById('calendar-btn');

    // Получаем ID студента из шаблона
    const studentId = "{{ student_id }}";
    let lastUpdate = new Date().toISOString();
    let messageCheckInterval = null;

    // Функции для работы с модальными окнами
    function openModal(modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Если открывается чат, запускаем проверку сообщений
        if (modal === chatModal) {
            startMessageChecking();
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
    }

    function closeModal(modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        
        // Если закрывается чат, останавливаем проверку сообщений
        if (modal === chatModal) {
            stopMessageChecking();
        }
    }

    // Управление интервалом проверки сообщений
    function startMessageChecking() {
        // Сначала выполняем немедленную проверку
        checkForNewMessages();
        // Затем устанавливаем интервал
        messageCheckInterval = setInterval(checkForNewMessages, 3000);
    }

    function stopMessageChecking() {
        if (messageCheckInterval) {
            clearInterval(messageCheckInterval);
            messageCheckInterval = null;
        }
    }

    // Event Listeners for Modals
    addFoodBtn.addEventListener('click', () => openModal(foodModal));
    contactBtn.addEventListener('click', () => openModal(chatModal));

    closeModalBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.modal');
            closeModal(modal);
        });
    });

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target);
        }
    });

    // Day Cards Click Event
    dayCards.forEach(card => {
        card.addEventListener('click', () => {
            const day = card.getAttribute('data-day');
            document.getElementById('day-title').textContent = day.charAt(0).toUpperCase() + day.slice(1) + ', 14 мая';
            openModal(dayDetailsModal);
        });
    });

    // Food Form Submission
    foodForm.addEventListener('submit', (e) => {
        e.preventDefault();
        closeModal(foodModal);
        showNotification('Еда успешно добавлена!');
        foodForm.reset();
    });

    // Chat Functionality
    sendMessageBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            try {
                const response = await fetch('http://127.0.0.1:8080/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        message: message
                    })
                });
    
                const data = await response.json();
                
                if (data.status === 'success') {
                    const messageHTML = `
                        <div class="message sent">
                            <div class="message-content">
                                <div class="message-text">${message}</div>
                                <div class="message-time">${data.time}</div>
                            </div>
                        </div>
                    `;
                    
                    chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                    messageInput.value = '';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Обновляем lastUpdate после отправки сообщения
                    lastUpdate = new Date().toISOString();
                } else {
                    showNotification('Ошибка при отправке сообщения');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Ошибка соединения');
            }
        }
    }

    async function checkForNewMessages() {
        try {
            const response = await fetch(`/get_new_messages/${studentId}?last_update=${lastUpdate}`);
            const data = await response.json();
            
            if (data.status === 'success' && data.messages.length > 0) {
                // Обновляем timestamp последнего сообщения
                lastUpdate = data.last_update;
                
                // Добавляем новые сообщения в чат
                data.messages.forEach(msg => {
                    const messageHTML = `
                        <div class="message received">
                            <div class="message-avatar">
                                <img src="{{ cookies.avatar if cookies.avatar else '../../static/assets/images/default_avatar.png' }}" 
                                     alt="Аватар {{ cookies.name }}">
                            </div>
                            <div class="message-content">
                                <div class="message-sender">{{ cookies.name }}</div>
                                <div class="message-text">${msg.content}</div>
                                <div class="message-time">${msg.time}</div>
                            </div>
                        </div>
                    `;
                    
                    chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                });
                
                // Прокручиваем к новым сообщениям
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        } catch (error) {
            console.error('Error checking for new messages:', error);
            // Не показываем уведомление, чтобы не раздражать пользователя
        }
    }

    // Вспомогательная функция для уведомлений
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.classList.add('notification');
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
        // Add animation classes
        document.querySelectorAll('.card').forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('animate-in');
            }, index * 100);
        });

        // Calendar Button Click Event
        calendarBtn.addEventListener('click', () => {
            const id = "{{ cookies.id }}";
            window.location.href = `/calendar/${id}`;
        });

        // Запускаем проверку сообщений при загрузке страницы, если чат открыт
        if (chatModal.classList.contains('active')) {
            startMessageChecking();
        }
    });
</script>
{% endblock %}